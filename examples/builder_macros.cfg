# ===============================
# macro-builder: builder_macros.cfg
# ===============================
# Include this file at the TOP of your printer.cfg:
#     [include builder_macros.cfg]
#
# What you get:
# - Two visible macros to RUN the builders and SHOW the summaries:
#     * BUILDER_KLIPPER_BUILD / BUILDER_KLIPPER_SHOW
#     * BUILDER_KATAPULT_BUILD / BUILDER_KATAPULT_SHOW
# - Two shell backends to actually flash via CAN/USB:
#     * FLASH_CAN  (gcode_shell_command)    ← not shown as a button
#     * FLASH_USB  (gcode_shell_command)    ← not shown as a button
#
# The builders will print suggested commands either as:
#   - SSH commands, or
#   - RUN_SHELL_COMMAND lines using the backends above (if you set "flash terminal: gcode_shell")

# --- Flash backends (hidden from UI: they are gcode_shell_command) ---

# --- Builder: KLIPPER ---
[gcode_shell_command BUILDER_KLIPPER_RUN]
command: bash -lc '${HOME}/macro-builder/build_klipper.sh'
timeout: 6000
verbose: True

[gcode_shell_command BUILDER_KLIPPER_SHOW]
command: bash -lc 'test -f ${HOME}/printer_data/system/builder_klipper_last.txt && cat ${HOME}/printer_data/system/builder_klipper_last.txt'
timeout: 20
verbose: True

[gcode_macro BUILD_KLIPPER]
description: Build Klipper and show the summary
gcode:
  RUN_SHELL_COMMAND CMD=BUILDER_KLIPPER_RUN
  RUN_SHELL_COMMAND CMD=BUILDER_KLIPPER_SHOW

# Optional
#[gcode_macro SHOW_LAST_KLIPPER_BUILD]
#description: Show last klipper build
#gcode:
#  RUN_SHELL_COMMAND CMD=BUILDER_KLIPPER_SHOW


# --- Builder: KATAPULT ---
[gcode_shell_command BUILDER_KATAPULT_RUN]
command: bash -lc '${HOME}/macro-builder/build_katapult.sh'
timeout: 6000
verbose: True

[gcode_shell_command BUILDER_KATAPULT_SHOW]
command: bash -lc 'test -f ${HOME}/printer_data/system/builder_katapult_last.txt && cat ${HOME}/printer_data/system/builder_katapult_last.txt'
timeout: 20
verbose: True

[gcode_macro BUILD_KATAPULT]
description: Build Katapult and show the summary
gcode:
  RUN_SHELL_COMMAND CMD=BUILDER_KATAPULT_RUN
  RUN_SHELL_COMMAND CMD=BUILDER_KATAPULT_SHOW

# Optional
#[gcode_macro SHOW_LAST_KATAPULT_BUILD]
#description: Show last katapult build
#gcode:
#  RUN_SHELL_COMMAND CMD=BUILDER_KATAPULT_SHOW


# --- Reccommaned to not make button macros ---
[gcode_shell_command FLASH_CAN]
command: bash -lc 'python3 ${HOME}/katapult/scripts/flash_can.py {params}'
timeout: 180
verbose: True

[gcode_shell_command FLASH_USB]
command: bash -lc 'python3 ${HOME}/katapult/scripts/flashtool.py {params}'
timeout: 180
verbose: True